name: MSA Navigation Warnings Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  scrape:
    runs-on: ubuntu-22.04  # æ”¹ç”¨ Ubuntu 22.04 (æ›´ç©©å®š)
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          gnupg \
          unzip \
          curl \
          xvfb \
          libxi6 \
          libgconf-2-4 \
          libnss3 \
          libxss1 \
          libappindicator3-1 \
          libasound2 \
          libatk-bridge2.0-0 \
          libgtk-3-0 \
          libx11-xcb1 \
          libxcomposite1 \
          libxcursor1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libgbm1 \
          libpango-1.0-0 \
          libcairo2 \
          fonts-liberation \
          fonts-noto-cjk
    
    - name: ğŸŒ Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
    
    - name: ğŸ” Verify installations
      run: |
        echo "=== Python Version ==="
        python --version
        echo ""
        echo "=== Chrome Version ==="
        google-chrome --version
        echo ""
        echo "=== Python Packages ==="
        python -c "import selenium; print('âœ… Selenium:', selenium.__version__)"
        python -c "import bs4; print('âœ… BeautifulSoup4:', bs4.__version__)"
        python -c "import requests; print('âœ… Requests:', requests.__version__)"
        python -c "import pandas; print('âœ… Pandas:', pandas.__version__)"
        python -c "try: import matplotlib; print('âœ… Matplotlib:', matplotlib.__version__); except: print('âš ï¸ Matplotlib: Not installed')"
        python -c "try: import cartopy; print('âœ… Cartopy:', cartopy.__version__); except: print('âš ï¸ Cartopy: Not installed')"
    
    - name: ğŸš€ Run scraper
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        TARGET_EMAIL: ${{ secrets.TARGET_EMAIL }}
      run: |
        xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24" python n8n_msa_monitor.py
    
    - name: ğŸ“¤ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scrape-results-${{ github.run_number }}
        path: |
          *.db
          *.xlsx
          maps/*.png
        retention-days: 7
    
    - name: ğŸ“Š Upload logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-logs-${{ github.run_number }}
        path: |
          *.log
        retention-days: 3
