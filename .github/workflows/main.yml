name: MSA Navigation Warnings Monitor

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ™‚åŸ·è¡Œä¸€æ¬¡ (UTCæ™‚é–“)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨é™¤éŒ¯æ¨¡å¼'
        required: false
        default: 'false'

jobs:
  scrape:
    runs-on: ubuntu-22.04
    timeout-minutes: 30  # è¨­å®šè¶…æ™‚æ™‚é–“
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1  # åªæŠ“å–æœ€æ–°ç‰ˆæœ¬ï¼ŒåŠ å¿«é€Ÿåº¦
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Cache system dependencies
      uses: awalsh128/cache-apt-pkgs-action@latest
      with:
        packages: >
          wget gnupg unzip curl xvfb libxi6 libgconf-2-4 libnss3 
          libxss1 libappindicator3-1 libasound2 libatk-bridge2.0-0 
          libgtk-3-0 libx11-xcb1 libxcomposite1 libxcursor1 libxdamage1 
          libxfixes3 libxrandr2 libgbm1 libpango-1.0-0 libcairo2 
          fonts-liberation fonts-noto-cjk
        version: 1.0
    
    - name: ğŸŒ Setup Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        pip install --no-cache-dir --upgrade pip setuptools wheel
        pip install --no-cache-dir -r requirements.txt
    
    - name: ğŸ” Verify installations
      run: |
        echo "::group::System Information"
        echo "ğŸ–¥ï¸ OS: $(lsb_release -d | cut -f2)"
        echo "ğŸ Python: $(python --version)"
        echo "ğŸŒ Chrome: $(google-chrome --version)"
        echo "ğŸ’¾ Disk Space: $(df -h / | awk 'NR==2 {print $4 " available"}')"
        echo "ğŸ§  Memory: $(free -h | awk 'NR==2 {print $7 " available"}')"
        echo "::endgroup::"
        
        echo "::group::Python Packages"
        python -c "
import sys
packages = {
    'selenium': 'Selenium',
    'bs4': 'BeautifulSoup4',
    'requests': 'Requests',
    'pandas': 'Pandas',
    'openpyxl': 'OpenPyXL',
    'webdriver_manager': 'WebDriver Manager'
}
for module, name in packages.items():
    try:
        mod = __import__(module)
        version = getattr(mod, '__version__', 'unknown')
        print(f'âœ… {name}: {version}')
    except ImportError:
        print(f'âŒ {name}: Not installed')
        sys.exit(1)
"
        echo "::endgroup::"
    
    - name: ğŸ”§ Prepare environment
      run: |
        # å»ºç«‹å¿…è¦çš„ç›®éŒ„
        mkdir -p maps logs
        
        # è¨­å®šé¡¯ç¤ºç’°å¢ƒè®Šæ•¸
        echo "DISPLAY=:99" >> $GITHUB_ENV
        
        # æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
        if [ -z "${{ secrets.TEAMS_WEBHOOK_URL }}" ]; then
          echo "âš ï¸ Warning: TEAMS_WEBHOOK_URL not set"
        fi
    
    - name: ğŸš€ Run scraper with retry
      id: scraper
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        TARGET_EMAIL: ${{ secrets.TARGET_EMAIL }}
        PYTHONUNBUFFERED: 1
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0
        EXIT_CODE=1
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ $EXIT_CODE -ne 0 ]; do
          echo "::group::åŸ·è¡Œçˆ¬èŸ² (å˜—è©¦ $((RETRY_COUNT + 1))/$MAX_RETRIES)"
          
          if xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24 -ac" \
             timeout 25m python n8n_msa_monitor.py 2>&1 | tee logs/scraper_$RETRY_COUNT.log; then
            EXIT_CODE=0
            echo "âœ… åŸ·è¡ŒæˆåŠŸ"
          else
            EXIT_CODE=$?
            echo "âŒ åŸ·è¡Œå¤±æ•— (Exit Code: $EXIT_CODE)"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ ç­‰å¾… 30 ç§’å¾Œé‡è©¦..."
              sleep 30
            fi
          fi
          
          echo "::endgroup::"
        done
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "::error::çˆ¬èŸ²åŸ·è¡Œå¤±æ•— (å·²é‡è©¦ $MAX_RETRIES æ¬¡)"
          exit 1
        fi
    
    - name: ğŸ“Š Generate summary
      if: always()
      run: |
        echo "## ğŸ“‹ åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "*.db" ]; then
          DB_SIZE=$(du -h *.db 2>/dev/null | cut -f1 | head -1)
          echo "- ğŸ“¦ è³‡æ–™åº«å¤§å°: ${DB_SIZE:-N/A}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f "*.xlsx" ]; then
          EXCEL_SIZE=$(du -h *.xlsx 2>/dev/null | cut -f1 | head -1)
          echo "- ğŸ“Š Excel å¤§å°: ${EXCEL_SIZE:-N/A}" >> $GITHUB_STEP_SUMMARY
        fi
        
        MAP_COUNT=$(ls maps/*.png 2>/dev/null | wc -l)
        echo "- ğŸ—ºï¸ åœ°åœ–æ•¸é‡: $MAP_COUNT" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
    
    - name: ğŸ“¤ Upload results
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: scrape-results-${{ github.run_number }}
        path: |
          *.db
          *.xlsx
          maps/*.png
        retention-days: 7
        if-no-files-found: warn
    
    - name: ğŸ“¤ Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-logs-${{ github.run_number }}
        path: |
          logs/*.log
          error_log.txt
          error_screenshot.png
        retention-days: 3
        if-no-files-found: ignore
    
    - name: ğŸ”” Notify on failure
      if: failure()
      run: |
        echo "::error::âŒ å·¥ä½œæµç¨‹åŸ·è¡Œå¤±æ•—"
        echo "::error::è«‹æª¢æŸ¥æ—¥èªŒä»¥ç²å–è©³ç´°è³‡è¨Š"
        
        # å¦‚æœæœ‰éŒ¯èª¤æˆªåœ–ï¼Œé¡¯ç¤ºæç¤º
        if [ -f "error_screenshot.png" ]; then
          echo "::warning::å·²ç”¢ç”ŸéŒ¯èª¤æˆªåœ–ï¼Œè«‹æŸ¥çœ‹ artifacts"
        fi
    
    - name: ğŸ§¹ Cleanup
      if: always()
      run: |
        # æ¸…ç†æš«å­˜æª”æ¡ˆ
        rm -rf /tmp/.X* /tmp/chrome* 2>/dev/null || true
        
        # é¡¯ç¤ºæœ€çµ‚ç£ç¢Ÿä½¿ç”¨ç‹€æ³
        echo "::group::Final Disk Usage"
        df -h /
        echo "::endgroup::"
