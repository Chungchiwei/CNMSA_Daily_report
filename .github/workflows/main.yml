name: MSA Navigation Warnings Monitor

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  scrape:
    runs-on: ubuntu-22.04
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python with cache
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'  # å•Ÿç”¨ pip cache
        cache-dependency-path: 'requirements.txt'
    
    - name: ğŸ“¦ Install system dependencies (minimal)
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y -qq --no-install-recommends \
          wget \
          gnupg \
          xvfb \
          libnss3 \
          libxss1 \
          libgbm1 \
          fonts-liberation
    
    - name: ğŸŒ Install Chrome (cached)
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ğŸ“¦ Install Python dependencies (optimized)
      run: |
        pip install --upgrade pip
        pip install --no-cache-dir -r requirements-minimal.txt
    
    - name: ğŸš€ Run scraper
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        TARGET_EMAIL: ${{ secrets.TARGET_EMAIL }}
      run: |
        xvfb-run -a python n8n_msa_monitor.py
      timeout-minutes: 20
    
    - name: ğŸ“¤ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: results-${{ github.run_number }}
        path: |
          *.db
          *.xlsx
          maps/*.png
        retention-days: 7
