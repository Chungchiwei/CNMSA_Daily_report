name: MSA Navigation Warnings Monitor

on:
  schedule:
    - cron: '0 */12 * * *'  # æ¯12å°æ™‚åŸ·è¡Œä¸€æ¬¡ (UTCæ™‚é–“)
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      debug_mode:
        description: 'å•Ÿç”¨é™¤éŒ¯æ¨¡å¼'
        required: false
        default: 'false'

jobs:
  scrape:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: ðŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    # å»ºè­°ï¼šæš«æ™‚ç§»é™¤ apt cacheï¼Œå› ç‚ºå®ƒå¸¸å›  lock file å°Žè‡´æµç¨‹ç›´æŽ¥å¤±æ•—
    # å¦‚æžœä¸€å®šè¦ç”¨ï¼Œè«‹ç¢ºä¿å®ƒä¸æœƒå› ç‚º cache miss è€Œå ±éŒ¯
    - name: ðŸ“¦ Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget unzip curl xvfb libxi6 libgconf-2-4 libnss3 \
          libxss1 libappindicator3-1 libasound2 libatk-bridge2.0-0 \
          libgtk-3-0 libx11-xcb1 libxcomposite1 libxcursor1 libxdamage1 \
          libxfixes3 libxrandr2 libgbm1 libpango-1.0-0 libcairo2 \
          fonts-liberation fonts-noto-cjk
    
    - name: ðŸŒ Setup Chrome and ChromeDriver
      uses: browser-actions/setup-chrome@latest
      with:
        chrome-version: stable
    
    - name: ðŸ“¦ Install Python dependencies
      run: |
        pip install --no-cache-dir --upgrade pip setuptools wheel
        pip install --no-cache-dir -r requirements.txt
    
    - name: ðŸ”§ Prepare environment
      run: |
        mkdir -p maps logs
        # è®“ Python è…³æœ¬çŸ¥é“ Chrome å®‰è£åœ¨å“ªè£¡ (setup-chrome æœƒè¨­å®šæ­¤è·¯å¾‘)
        echo "CHROME_BINARY_LOCATION=$(which google-chrome)" >> $GITHUB_ENV
        
        # æª¢æŸ¥ Secret æ˜¯å¦å­˜åœ¨ (é™¤éŒ¯ç”¨)
        if [ -z "${{ secrets.TEAMS_WEBHOOK_URL }}" ]; then
          echo "âš ï¸ Warning: TEAMS_WEBHOOK_URL is NOT set in Secrets!"
        else
          echo "âœ… TEAMS_WEBHOOK_URL is detected."
        fi
    
    - name: ðŸš€ Run scraper with retry
      id: scraper
      shell: bash
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        TARGET_EMAIL: ${{ secrets.TARGET_EMAIL }}
        PYTHONUNBUFFERED: 1
        # å‚³éž Chrome è·¯å¾‘çµ¦ Python (å¦‚æžœæ‚¨çš„ Python ç¨‹å¼æœ‰ä½¿ç”¨æ­¤è®Šæ•¸)
        CHROME_PATH: /usr/bin/google-chrome 
      run: |
        MAX_RETRIES=3
        RETRY_COUNT=0
        EXIT_CODE=1
        
        # å•Ÿç”¨ pipefailï¼Œé€™æ¨£å¦‚æžœ Python å¤±æ•—ï¼Œæ•´å€‹æŒ‡ä»¤æ‰æœƒå›žå‚³å¤±æ•—ï¼Œè€Œä¸æ˜¯å›žå‚³ tee çš„æˆåŠŸ
        set -o pipefail
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ $EXIT_CODE -ne 0 ]; do
          echo "::group::åŸ·è¡Œçˆ¬èŸ² (å˜—è©¦ $((RETRY_COUNT + 1))/$MAX_RETRIES)"
          
          # ä½¿ç”¨ xvfb-run åŸ·è¡Œï¼Œä¸¦å°‡è¼¸å‡ºåŒæ™‚é¡¯ç¤ºä¸¦å¯«å…¥ log
          # æ³¨æ„ï¼šé€™è£¡ä¿®æ­£äº† pipe æŽ©è“‹éŒ¯èª¤ä»£ç¢¼çš„å•é¡Œ
          if xvfb-run --auto-servernum --server-args="-screen 0 1920x1080x24 -ac" \
             timeout 25m python n8n_msa_monitor.py 2>&1 | tee logs/scraper_$RETRY_COUNT.log; then
            EXIT_CODE=0
            echo "âœ… åŸ·è¡ŒæˆåŠŸ"
          else
            # é€™è£¡æŠ“åˆ°çš„ $? æœƒæ˜¯ python çš„éŒ¯èª¤ç¢¼ (å› ç‚º set -o pipefail)
            EXIT_CODE=$?
            echo "âŒ åŸ·è¡Œå¤±æ•— (Exit Code: $EXIT_CODE)"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ ç­‰å¾… 30 ç§’å¾Œé‡è©¦..."
              sleep 30
            fi
          fi
          
          echo "::endgroup::"
        done
        
        # æ¢å¾© pipefail è¨­å®š (é›–ç„¶å¾Œé¢æ²’æŒ‡ä»¤äº†ï¼Œä½†é€™æ˜¯å¥½ç¿’æ…£)
        set +o pipefail
        
        if [ $EXIT_CODE -ne 0 ]; then
          echo "::error::çˆ¬èŸ²åŸ·è¡Œå¤±æ•— (å·²é‡è©¦ $MAX_RETRIES æ¬¡)"
          exit 1
        fi
    
    - name: ðŸ“Š Generate summary
      if: always()
      run: |
        echo "## ðŸ“‹ åŸ·è¡Œæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # ä¿®æ­£ï¼šå®‰å…¨çš„æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨çš„æ–¹æ³• (é¿å… Wildcard Expansion éŒ¯èª¤)
        count_db=$(ls *.db 2>/dev/null | wc -l)
        if [ "$count_db" != "0" ]; then
          DB_SIZE=$(du -h *.db 2>/dev/null | cut -f1 | head -1)
          echo "- ðŸ“¦ è³‡æ–™åº«å¤§å°: ${DB_SIZE:-N/A}" >> $GITHUB_STEP_SUMMARY
        else
           echo "- ðŸ“¦ ç„¡ç”¢ç”Ÿè³‡æ–™åº«æª”æ¡ˆ" >> $GITHUB_STEP_SUMMARY
        fi
        
        count_xlsx=$(ls *.xlsx 2>/dev/null | wc -l)
        if [ "$count_xlsx" != "0" ]; then
          EXCEL_SIZE=$(du -h *.xlsx 2>/dev/null | cut -f1 | head -1)
          echo "- ðŸ“Š Excel å¤§å°: ${EXCEL_SIZE:-N/A}" >> $GITHUB_STEP_SUMMARY
        fi
        
        MAP_COUNT=$(ls maps/*.png 2>/dev/null | wc -l)
        echo "- ðŸ—ºï¸ åœ°åœ–æ•¸é‡: $MAP_COUNT" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "â° åŸ·è¡Œæ™‚é–“: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ“¤ Upload results
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: scrape-results-${{ github.run_number }}
        path: |
          *.db
          *.xlsx
          maps/*.png
        retention-days: 7
        if-no-files-found: warn
    
    - name: ðŸ“¤ Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: execution-logs-${{ github.run_number }}
        path: |
          logs/*.log
          error_log.txt
          error_screenshot.png
        retention-days: 3
        if-no-files-found: ignore
