name: MSA Navigation Warnings Monitor

on:
  schedule:
    - cron: '0 */6 * * *'  # æ¯6å°æ™‚åŸ·è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è¨±æ‰‹å‹•è§¸ç™¼

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ğŸ“¦ Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          gnupg \
          unzip \
          curl \
          libgeos-dev \
          libproj-dev \
          proj-data \
          proj-bin \
          fonts-noto-cjk \
          xvfb \
          libxi6 \
          libgconf-2-4 \
          libnss3 \
          libxss1 \
          libasound2
    
    - name: ğŸŒ Install Chrome
      run: |
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        google-chrome --version
    
    - name: ğŸ“¦ Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ” Verify installations
      run: |
        python -c "import selenium; print('Selenium:', selenium.__version__)"
        python -c "import bs4; print('BeautifulSoup4:', bs4.__version__)"
        python -c "import requests; print('Requests:', requests.__version__)"
        python -c "try: import matplotlib; print('Matplotlib:', matplotlib.__version__); except: print('Matplotlib: Not installed')"
        python -c "try: import cartopy; print('Cartopy:', cartopy.__version__); except: print('Cartopy: Not installed')"
    
    - name: ğŸš€ Run scraper
      env:
        TEAMS_WEBHOOK_URL: ${{ secrets.TEAMS_WEBHOOK_URL }}
        MAIL_USER: ${{ secrets.MAIL_USER }}
        MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}
        TARGET_EMAIL: ${{ secrets.TARGET_EMAIL }}
      run: |
        xvfb-run -a python n8n_msa_monitor.py
    
    - name: ğŸ“¤ Upload artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: scrape-results
        path: |
          *.db
          *.xlsx
          maps/*.png
        retention-days: 7
